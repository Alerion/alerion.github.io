<!DOCTYPE HTML>
<html lang="en">
<head>
	<title>Обработка и визуализация геоданных</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=792, user-scalable=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<link rel="stylesheet" href="shower/themes/ribbon/styles/screen.css">
	<style>
	.slide.algo div {
		padding-top: 30px;
	}

	.slide.algo h2 {
		~margin-left: 50px;
		font-size: 1em;
	    text-align: center;
	}

	.slide.algo p {
		font-size: 0.9em;
	}

	.slide.algo img {
		width: 500px;
		margin-top: -30px;
	    margin-left: auto;
	    margin-right: auto;
	    display: block;
	}

	.slide.image img {
		width: 700px;
		margin-top: -70px;
	    margin-left: auto;
	    margin-right: auto;
	    display: block;
	}

	pre {
		font-size: 0.70em;
		line-height: normal;
	}
	</style>
</head>
<body class="list">
	<header class="caption">
		<h1>Обработка и визуализация геоданных</h1>

		<p>Косточко Дмитрий</p>
	</header>

	<!--
	В этом докладе я расскажу как я решал не совсем обычную задачу по визуализации геоданных.
	Расскажу немного теории, и о инструментах для работы с геоданными и их визуализации.
		-->
	<section class="slide"><div>
		<h2>Обработка и визуализация геоданных</h2>

		<p>Косточко Дмитрий</p>
	</div></section>

	<!--
	Все началось с того, что я перегорел на работе, уволился и решил поработать
	в свое удовольствие. Потрогать Python 3, asyncio, ReactJS, EECMAScript 6...
	В общем все то, что не так просто втащить в реальный проект.

	Мне нужна была задача, над которой смогу увлеченно сидеть часами.
		-->
	<section class="slide"><div>
		<img src="pictures/1.jpg" alt="" style="margin-top: 30px">
	</div></section>

	<section class="slide"><div>
		<h2>Задача</h2>
		<p>Создание игрового мира и его отображение на странице.</p>
		<ul>
			<li>Процедурная генерация мира.</li>
			<li>Работаем как с геоданными.</li>
			<li>Встраиваем на страницу как обычную карту.</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Плюсы решения</h2>
		<ul>
			<li>
				Процедурно можно создать сколько угодно миров с разными параметрами, проверять механику на разных мирах.
			</li>
			<li>
				Работа с геоданными позволяет использовать готовые инструменты, структуры данных и решения.
				Ниже порог вхождения и стоимость поддержки, можно найти готовые решения стандартных задач.
			</li>
			<li>
				Минимальная необходимость в дизайнере и графике.
			</li>
			<li>
				Можно создавать как плоский мир, так и целую планету.
			</li>
		</ul>
	</div></section>

	<section class="slide algo"><div>
		<h2>Архитектура приложения</h2>
		<img src="pictures/schema.png" alt="" style="width: auto; height: 480px">
	</div></section>

	<section class="slide"><div>
		<h2>Генерация мира</h2>

		<ol>
			<li>Разбиваем плоскость на полигоны.</li>
			<li>Определяем является ли полигон сушей.</li>
			<li>Генерируем карту высот.</li>
			<li>Генерируем реки.</li>
			<li>Рассчитываем биомы.</li>
			<li>Генерируем игровые объекты (города, регионы).</li>
		</ol>
	</div></section>

	<section class="slide algo"><div>
		<h2>Генерация случайных точек</h2>
		<img src="pictures/algo1.png" alt="">
	</div></section>

	<section class="slide algo"><div>
		<h2>Релаксация Ллойда</h2>
		<img src="pictures/algo2.png" alt="">
	</div></section>

	<section class="slide algo"><div>
		<h2>Строим диаграмму Вороного и нормализируем ребра</h2>
		<img src="pictures/algo4.png" alt="">
	</div></section>

	<section class="slide algo"><div>
		<h2>Создаем острова, используя шум Перлина</h2>
		<img src="pictures/algo5(islands_level=1.5).png" alt="">
	</div></section>

	<section class="slide algo"><div>
		<h2>Шум Перлина</h2>
		<p>Алгоритм генерации процедурной текстуры псевдослучайным методом. Используется в компьютерной графике для увеличения реализма текстур, генерации эффектов дыма, тумана и т.д.</p>
		<img src="pictures/perlin_noise.jpg" alt="">
	</div></section>

	<section class="slide algo"><div>
		<h2>Расчет высот</h2>
		<img src="pictures/algo6.png" alt="">
	</div></section>

	<section class="slide algo"><div>
		<h2>Создание рек</h2>
		<img src="pictures/algo7.png" alt="">
	</div></section>

	<section class="slide algo"><div>
		<h2>Расчет осадков</h2>
		<img src="pictures/algo8.png" alt="">
	</div></section>

	<!--
	Based on Whittaker diagram
		-->
	<section class="slide"><div>
		<h2>Диаграмма биомов</h2>
		<img src="pictures/biomes.png" alt="">
	</div></section>

	<section class="slide algo"><div>
		<h2>Определяем биомы</h2>
		<img src="pictures/algo9.png" alt="">
	</div></section>

	<!--
	Гексовая сетка.
		-->
	<section class="slide algo"><div>
		<h2>Добавляем города и регионы</h2>
		<img src="pictures/algo10.png" alt="">
	</div></section>

	<section class="slide"><div>
		<h2>Используемые библиотеки</h2>
		<ul>
			<li>numpy (array, random)</li>
			<li>skipy (KDTree, Voronoi)</li>
			<li>shapely</li>
			<li>noise</li>
			<li>matplotlib</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Геоданные</h2>
		<p>Информация, которая имеет географическую (пространственную) привязку.</p>
		<ul>
			<li>Векторные – описываются набором или последовательностью координат, геометрией и атрибутивными значениями.</li>
			<li>Растровые – растровые изображения с геопривязкой, например снимки спутников.</li>
		<ul>
	</div></section>

	<section class="slide"><div>
		<h2>PostgreSQL/PostGIS + GeoDjango</h2>

		<pre>
			<code>from django.contrib.gis.db import models</code>
			<code>&nbsp;</code>
			<code>&nbsp;</code>
			<code>class Biome(models.Model):</code>
			<code>    name = models.CharField(max_length=100)</code>
			<code>    biome = models.CharField(max_length=50, choices=BIOMES)</code>
			<code>    geom = models.MultiPolygonField(srid=4326)  # WGS 84</code>
			<code>&nbsp;</code>
			<code>    objects = models.GeoManager()</code>
			<code>&nbsp;</code>
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2>Mapnik</h2>

		<p>Открытая библиотека для рендеринга растровых карт из векторных данных.</p>
		<p><a href="http://mapnik.org/">http://mapnik.org/</a></p>
	</div></section>

	<section class="slide"><div>
		<h2>mapnik_config.xml</h2>

		<pre>
			<code>&lt;Map&gt;</code>
			<code>    &lt;Style&gt;</code>
			<code>        &lt;Rule/&gt;</code>
			<code>    &lt;Style/&gt;</code>
			<code>    &lt;Layer&gt;</code>
			<code>        &lt;StyleName/&gt;</code>
			<code>        &lt;Datasource/&gt;</code>
			<code>    &lt;/Layer&gt;</code>
			<code>&lt;/Map&gt;</code>
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2>mapnik_config.xml</h2>

		<pre>
		    <code>&lt;Rule&gt;</code>
		    <code>    &lt;PolygonSymbolizer fill="#abceff"/&gt;</code>
		    <code>    &lt;LineSymbolizer stroke="#abceff" stroke-width="1"  stroke-linejoin="round"/&gt;</code>
		    <code>    &lt;Filter&gt;[biome] = 'OCEAN'&lt;/Filter&gt;</code>
		    <code>&lt;/Rule&gt;</code>
		    <code>&nbsp;</code>
		    <code>&lt;Rule&gt;</code>
		    <code>    &lt;PolygonPatternSymbolizer file="./tiles/GRASSLAND.png"/&gt;</code>
		    <code>    &lt;LineSymbolizer stroke-width="0"/&gt;</code>
		    <code>    &lt;Filter&gt;[biome] = 'GRASSLAND'&lt;/Filter&gt;</code>
		    <code>&lt;/Rule&gt;</code>
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2>CartoCSS</h2>

		<pre>
			<code>#buildings {</code>
			<code>  [zoom >= 13] {</code>
			<code>    polygon-fill: @building-low-zoom;</code>
			<code>    polygon-clip: false;</code>
			<code>    [zoom >= 15] {</code>
			<code>      line-color: @building-line;</code>
			<code>      polygon-fill: @building-fill;</code>
			<code>      line-width: .75;</code>
			<code>      line-clip: false;</code>
			<code>    }</code>
			<code>  }</code>
			<code>}</code>
		</pre>
	</div></section>


	<section class="slide"><div>
		<h2>Hillshade</h2>

		<img src="pictures/hillshade3.png" alt="" style="width: 700px">
	</div></section>

	<section class="slide algo"><div>
		<h2>Карта высот (2000 полигонов + шум)</h2>
		<img src="pictures/hillshade2.png" alt="">
	</div></section>

	<section class="slide"><div>
		<h2>Тайловый сервер</h2>

		<p>
			Рендерит и сохраняет в кэше тайлы, отдает их клиенту.
		</p>

		<ul>
			<li>TileStache</li>
			<li>TileCache</li>
			<li>mod_tile (Apache)</li>
			<li>TileStream</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Подключаем карту на страницу с помощью Leaflet</h2>

		<pre>
			<code>&lt;div id="map" style="width: 1200px; height: 900px" /&gt;</code>
			<code>&lt;script&gt;</code>
        	<code>    var map = L.map('map').setView([0, 0], 4);</code>
        	<code>    L.tileLayer('http://127.0.0.1:8080/map/{z}/{x}/{y}.png').addTo(map);</code>
        	<code>&lt;/script&gt;</code>
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2>Получаем данные в GeoJSON из базы данных</h2>

		<pre>
			<code>from django.core.serializers import serialize</code>
			<code>&nbsp;</code>
			<code>&nbsp;</code>
			<code>def regions_data(request):</code>
			<code>    output = serialize('geojson', Region.objects.all(),</code>
			<code>                       geometry_field='geom', fields=('name', 'geom'))</code>
			<code>    return HttpResponse(output, content_type='text/json')</code>
			<code>&nbsp;</code>
		</pre>
	</div></section>

	<section class="slide"><div>
		<h2>Показываем регионы на карте</h2>

		<pre>
	        <code>$.getJSON(regionsURL, function(data) {</code>
	        <code>    L.geoJson(data, {</code>
	        <code>        onEachFeature: function (feature, layer) {</code>
	        <code>            layer.bindPopup(feature.properties.name, {maxWidth: 200});</code>
	        <code>        },</code>
	        <code>        style: function(feature) {</code>
	        <code>            return {</code>
	        <code>                "color": randomColor()</code>
	        <code>            };</code>
	        <code>        }</code>
	        <code>    }).addTo(map);</code>
	        <code>});</code>
		</pre>
	</div></section>

	<section class="slide image"><div>
		<img src="pictures/map1.png" alt="">
	</div></section>

	<section class="slide image"><div>
		<img src="pictures/map2.png" alt="">
	</div></section>

	<section class="slide image"><div>
		<img src="pictures/map3.png" alt="">
	</div></section>

	<section class="slide image"><div>
		<img src="pictures/map4.png" alt="">
	</div></section>

	<section class="slide"><div>
		<h2>Планы на будущее</h2>

		<ul>
			<li>Добавить возможность создавать целую планету</li>
			<li>Добавить различные алгоритмы генерации материков</li>
			<li>Улучшить создание hillshade слоя</li>
			<li>Добавить больше игровых объектов: пещеры, дороги, достопримечательности и т.д.</li>
		</ul>
	</div></section>

	<section class="slide"><div>
		<h2>Спасибо</h2>

		<p>
			Посмотреть код:
			<a href="https://github.com/Alerion/fantasy_map">https://github.com/Alerion/fantasy_map</a>
		</p>

		<p>
			Описание алгоритма:
			<a href="http://www-cs-students.stanford.edu/~amitp/game-programming/polygon-map-generation/">
				http://www-cs-students.stanford.edu/~amitp/game-programming/polygon-map-generation/
			</a>
		</p>
	</div></section>
	<!--
		To hide progress bar from entire presentation
		just remove “progress” element.
		-->
	<div class="progress"><div></div></div>
	<script src="shower/shower.min.js"></script>
	<!-- Copyright © 2014 Yours Truly, Famous Inc. -->
	<!-- Photos by John Carey, fiftyfootshadows.net -->
</body>
</html>